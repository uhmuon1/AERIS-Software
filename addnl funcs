// PIO program declaration
extern const PIO_program i2c_program;

// Function to check if address is reserved
static bool reserved_addr(uint8_t addr) {
    return (addr & 0x78) == 0 || (addr & 0x78) == 0x78;
}

// Basic I2C read function using PIO
static int pio_i2c_read_blocking(PIO pio, uint sm, uint8_t addr, uint8_t *rxbuf, uint len) {
    int bytes_read = 0;
    
    // Start condition
    pio_sm_put(pio, sm, (addr << 1) | 1);  // Address + read bit
    
    // Check for ACK/NAK
    if (pio_sm_get(pio, sm) & 1) {
        return -1;  // NAK received
    }
    
    // Read data if requested
    while (len--) {
        pio_sm_put(pio, sm, len == 0);  // Send NAK on last byte
        *rxbuf++ = pio_sm_get(pio, sm) >> 24;  // Get received byte
        bytes_read++;
    }
    
    // Stop condition
    pio_sm_put(pio, sm, 1);
    
    return bytes_read;
}
